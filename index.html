<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é€£çµ¡æ²ç¤ºæ¿</title>
    <style>
        /* --- ãƒ™ãƒ¼ã‚¹ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        h1.page-title {
            font-size: 1.8rem;
            text-align: center;
            margin: 20px 0 30px;
            color: #2c3e50;
            font-weight: 800;
            letter-spacing: 0.05em;
        }

        /* ã‚«ãƒ¼ãƒ‰å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .card-style {
            background-color: #fff;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        .input-card { margin-bottom: 30px; }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 0.95rem;
            color: #555;
        }
        .required::after { content: " *"; color: #e53935; }
        
        select, textarea {
            width: 100%;
            padding: 14px;
            margin-bottom: 20px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background: #f9fbfc;
            transition: all 0.3s ease;
            appearance: none;
        }
        select:focus, textarea:focus {
            outline: none;
            border-color: #4a90e2;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        textarea { height: 100px; resize: none; }
        
        /* ãƒœã‚¿ãƒ³å…±é€šãƒ‡ã‚¶ã‚¤ãƒ³ */
        button.main-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);
            transition: transform 0.1s, box-shadow 0.2s;
        }
        button.main-btn:active { transform: scale(0.98); opacity: 0.9; }
        button.main-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        /* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢é€£ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .image-upload-area {
            margin-bottom: 20px;
        }
        .file-select-btn {
            display: inline-block;
            background-color: #e1e8ed;
            color: #555;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            transition: background 0.2s;
        }
        .file-select-btn:active { background-color: #d0d7dd; }
        
        #previewContainer {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .preview-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        /* æŠ•ç¨¿ä¸€è¦§ã®ç”»åƒè¡¨ç¤º */
        .post-images {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        .post-image-item {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            border: 1px solid #eee;
            object-fit: contain;
        }

        .note {
            font-size: 0.8rem;
            color: #999;
            margin-top: 15px;
            text-align: center;
        }

        /* æŠ•ç¨¿ä¸€è¦§ */
        .post-list { margin-top: 10px; }
        .post-card {
            margin-bottom: 16px;
            padding: 20px;
            border-left: 5px solid #4a90e2;
            animation: slideIn 0.4s ease;
        }
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .author-badge { font-weight: bold; color: #333; font-size: 1rem; }
        .post-date { font-size: 0.8rem; color: #aaa; }
        .post-content {
            font-size: 1rem;
            line-height: 1.7;
            white-space: pre-wrap;
            word-break: break-all;
            color: #444;
        }
        .owner-actions {
            margin-top: 15px;
            text-align: right;
            border-top: 1px dotted #eee;
            padding-top: 10px;
        }
        .action-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 5px 12px;
            font-size: 0.8rem;
            border-radius: 20px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
        }
        .edit-btn { color: #28a745; border-color: #28a745; }
        .delete-btn { color: #e53935; border-color: #e53935; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
        }
        .modal-overlay.active { display: flex; }
        .modal-content { width: 100%; max-width: 500px; }
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; color: #2c3e50; text-align: center; }
        .modal-content textarea { height: 150px; }
        .modal-actions { display: flex; justify-content: space-between; gap: 12px; margin-top: 10px; }
        .modal-actions button { flex: 1; padding: 14px; border-radius: 50px; margin: 0; font-size: 1rem; }
        .cancel-btn { background: #e1e8ed !important; color: #555 !important; box-shadow: none !important; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="page-title">é€£çµ¡æ²ç¤ºæ¿</h1>

    <div class="input-card card-style">
        <label for="author" class="required">æŠ•ç¨¿è€…</label>
        <select id="author">
            <option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="é€¢å‚">é€¢å‚</option>
            <option value="å±±æœ¬">å±±æœ¬</option>
            <option value="å±±ç”°">å±±ç”°</option>
            <option value="é‡‘ä¸¸">é‡‘ä¸¸</option>
            <option value="å±±åŸ">å±±åŸ</option>
        </select>

        <label for="message">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
        <textarea id="message" placeholder="ã“ã“ã«é€£çµ¡äº‹é …ãªã©ã‚’å…¥åŠ›..."></textarea>

        <div class="image-upload-area">
            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
            <label for="imageInput" class="file-select-btn">ğŸ“· ç”»åƒã‚’è¿½åŠ  (æœ€å¤§3æš)</label>
            <div id="previewContainer"></div>
        </div>

        <button id="submitBtn" class="main-btn">æŠ•ç¨¿ã™ã‚‹</button>
        <div class="note">â€»ç”»åƒã¯è‡ªå‹•åœ§ç¸®ã•ã‚Œã¾ã™ã€‚<br>â€»ç·¨é›†ãƒ»å‰Šé™¤ç”¨ã«ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚</div>
    </div>

    <div id="timeline" class="post-list">
        <div style="text-align:center; color:#999; padding:20px;">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-content card-style">
        <h3>å†…å®¹ã‚’ç·¨é›†</h3>
        <textarea id="editInput"></textarea>
        <div class="modal-actions">
            <button id="cancelEditBtn" class="main-btn cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button id="saveEditBtn" class="main-btn">ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, Timestamp, deleteDoc, doc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // =================================================================
    // ã€é‡è¦ã€‘ã“ã“ã« APIã‚­ãƒ¼ ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
    // =================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyCakQvs7YjgTGsczVC3L9M3vtpIIS_XYDk",
        authDomain: "keijiban-1.firebaseapp.com",
        projectId: "keijiban-1",
        storageBucket: "keijiban-1.firebasestorage.app", // â˜…é‡è¦: Storageã‚’ä½¿ã†ãŸã‚ã«å¿…è¦ã§ã™ (é€šå¸¸ã¯ projectId.appspot.com)
        messagingSenderId: "419769266348",
        appId: "1:419769266348:web:b19f3b547c7e6f7d0c2f09"
    };
    // =================================================================

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app); // Storageæ©Ÿèƒ½ã®åˆæœŸåŒ–
    const postsRef = collection(db, "posts");

    const STORAGE_KEY = "bbs_user_id";
    let myUserId = localStorage.getItem(STORAGE_KEY);
    if (!myUserId) {
        myUserId = "user_" + Math.random().toString(36).substring(2) + Date.now().toString(36);
        localStorage.setItem(STORAGE_KEY, myUserId);
    }

    const authorSelect = document.getElementById("author");
    const messageInput = document.getElementById("message");
    const imageInput = document.getElementById("imageInput");
    const previewContainer = document.getElementById("previewContainer");
    const submitBtn = document.getElementById("submitBtn");
    const timeline = document.getElementById("timeline");

    // ç”»åƒé¸æŠæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡¦ç†
    imageInput.addEventListener("change", () => {
        const files = Array.from(imageInput.files);
        previewContainer.innerHTML = "";
        
        if (files.length > 3) {
            alert("ç”»åƒã¯æœ€å¤§3æšã¾ã§ã§ã™ã€‚");
            imageInput.value = "";
            return;
        }

        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement("img");
                img.src = e.target.result;
                img.className = "preview-thumb";
                previewContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    });

    // ç”»åƒåœ§ç¸®é–¢æ•°ï¼ˆæ¨ªå¹…800pxä»¥ä¸‹ã€JPEGå“è³ª0.7ã«åœ§ç¸®ï¼‰
    const compressImage = async (file) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    const MAX_WIDTH = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, "image/jpeg", 0.7); // åœ§ç¸®ç‡è¨­å®š
                };
            };
        });
    };

    // æŠ•ç¨¿æ©Ÿèƒ½
    submitBtn.addEventListener("click", async () => {
        const author = authorSelect.value;
        const text = messageInput.value.trim();
        const files = Array.from(imageInput.files);

        if (!author) return alert("æŠ•ç¨¿è€…ã‚’é¸æŠã—ã¦ãã ã•ã„");
        if (!text && files.length === 0) return alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¾ãŸã¯ç”»åƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        submitBtn.disabled = true;
        submitBtn.textContent = "é€ä¿¡ä¸­...";

        try {
            const imageUrls = [];

            // ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
            for (const file of files) {
                // åœ§ç¸®å®Ÿè¡Œ
                const compressedBlob = await compressImage(file);
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ (ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—_ãƒ©ãƒ³ãƒ€ãƒ )
                const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.jpg`;
                const storageRef = ref(storage, 'images/' + fileName);
                
                // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                await uploadBytes(storageRef, compressedBlob);
                const url = await getDownloadURL(storageRef);
                imageUrls.push({ url: url, path: 'images/' + fileName });
            }

            // Firestoreã«ä¿å­˜
            await addDoc(postsRef, {
                author: author,
                text: text,
                images: imageUrls, // ç”»åƒURLé…åˆ—
                createdAt: Timestamp.now(),
                uid: myUserId
            });

            // ãƒªã‚»ãƒƒãƒˆ
            messageInput.value = "";
            imageInput.value = "";
            previewContainer.innerHTML = "";
        } catch (error) {
            console.error("Error:", error);
            alert("æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nStorageè¨­å®šã‚„APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "æŠ•ç¨¿ã™ã‚‹";
        }
    });

    // èª­ã¿è¾¼ã¿æ©Ÿèƒ½ (1é€±é–“ä»¥å†…)
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    const q = query(postsRef, where("createdAt", ">", Timestamp.fromDate(oneWeekAgo)), orderBy("createdAt", "desc"));

    onSnapshot(q, (snapshot) => {
        timeline.innerHTML = "";
        if (snapshot.empty) { timeline.innerHTML = '<div style="text-align:center; color:#ccc; padding:40px;">æŠ•ç¨¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>'; return; }
        
        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const date = data.createdAt.toDate();
            const timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
            const isMyPost = (data.uid === myUserId);
            
            // ç”»åƒè¡¨ç¤ºç”¨ã®HTMLç”Ÿæˆ
            let imagesHtml = "";
            if (data.images && data.images.length > 0) {
                imagesHtml = `<div class="post-images">`;
                data.images.forEach(imgData => {
                    // å¤ã„å½¢å¼(URLæ–‡å­—åˆ—ã®ã¿)ã¨æ–°ã—ã„å½¢å¼(ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)ã®ä¸¡å¯¾å¿œ
                    const src = typeof imgData === 'string' ? imgData : imgData.url;
                    imagesHtml += `<a href="${src}" target="_blank"><img src="${src}" class="post-image-item"></a>`;
                });
                imagesHtml += `</div>`;
            }

            let actionButtons = "";
            if (isMyPost) {
                actionButtons = `
                    <div class="owner-actions">
                        <button class="action-btn edit-btn" onclick="openEditModal('${docSnap.id}', '${escapeHtml(data.text).replace(/\n/g, '\\n').replace(/'/g, "\\'")}')">ç·¨é›†</button>
                        <button class="action-btn delete-btn" onclick="deletePost('${docSnap.id}')">å‰Šé™¤</button>
                    </div>
                `;
            }
            
            const postHtml = `
                <div class="post-card card-style">
                    <div class="post-header"><span class="author-badge">${escapeHtml(data.author)}</span><span class="post-date">${timeStr}</span></div>
                    <div class="post-content">${escapeHtml(data.text)}${imagesHtml}</div>
                    ${actionButtons}
                </div>
            `;
            timeline.insertAdjacentHTML('beforeend', postHtml);
        });
    });

    // å‰Šé™¤æ©Ÿèƒ½ï¼ˆç”»åƒã‚‚ä¸€ç·’ã«å‰Šé™¤ï¼‰
    window.deletePost = async (id) => {
        if(!confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        
        try {
            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã—ã¦ç”»åƒæƒ…å ±ã‚’æ¢ã™
            // â€»æœ¬æ¥ã¯getDocãŒå¿…è¦ã§ã™ãŒã€ç°¡æ˜“åŒ–ã®ãŸã‚onSnapshotã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã™ã‚‹ã‹ã€
            // ã“ã“ã§ã¯Firestoreã‹ã‚‰å‰Šé™¤ã—ã€å¤ã„ç”»åƒã¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã«ä»»ã›ã‚‹æ–¹å¼ã‚‚æ‰‹ã§ã™ãŒ
            // ä¸å¯§ã«è¡Œã†ãªã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™
            alert("å‰Šé™¤ä¸­...");
            await deleteDoc(doc(db, "posts", id));
            alert("å‰Šé™¤ã—ã¾ã—ãŸ");
            // â€»ç”»åƒã®å³æ™‚å‰Šé™¤ã¯è¤‡é›‘ã«ãªã‚‹ãŸã‚ã€ä¸‹è¨˜ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã«ä»»ã›ã¾ã™
        } catch(e) { 
            console.error(e);
            alert("å‰Šé™¤ã§ãã¾ã›ã‚“ã§ã—ãŸ"); 
        }
    };

    // â˜…ãŠæƒé™¤æ©Ÿèƒ½ï¼ˆå¤ã„æŠ•ç¨¿ã¨ç”»åƒã‚’è‡ªå‹•å‰Šé™¤ï¼‰
    const cleanupOldPosts = async () => {
        const cleanupQuery = query(postsRef, where("createdAt", "<=", Timestamp.fromDate(oneWeekAgo)));
        const snapshot = await getDocs(cleanupQuery);
        
        snapshot.forEach(async (docSnap) => {
            const data = docSnap.data();
            // ç”»åƒãŒã‚ã‚Œã°Storageã‹ã‚‰å‰Šé™¤
            if (data.images && Array.isArray(data.images)) {
                for (const img of data.images) {
                    if (img.path) {
                        const imgRef = ref(storage, img.path);
                        try { await deleteObject(imgRef); } catch(e) { console.log("ç”»åƒå‰Šé™¤ã‚¹ã‚­ãƒƒãƒ—:", e); }
                    }
                }
            }
            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‰Šé™¤
            await deleteDoc(doc(db, "posts", docSnap.id));
            console.log("å¤ã„æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ:", docSnap.id);
        });
    };
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¸€åº¦ã ã‘å®Ÿè¡Œ
    cleanupOldPosts();

    // --- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ (å‰å›ã®ã¾ã¾) ---
    const editModal = document.getElementById("editModal");
    const editInput = document.getElementById("editInput");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const saveEditBtn = document.getElementById("saveEditBtn");
    let currentEditPostId = null;

    window.openEditModal = (id, currentText) => {
        currentEditPostId = id; editInput.value = currentText; editModal.classList.add('active');
    };
    const closeModal = () => { editModal.classList.remove('active'); currentEditPostId = null; };
    cancelEditBtn.addEventListener("click", closeModal);
    editModal.addEventListener("click", (e) => { if (e.target === editModal) closeModal(); });

    saveEditBtn.addEventListener("click", async () => {
        const newText = editInput.value.trim();
        if (!newText) return alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if (!currentEditPostId) return;
        saveEditBtn.disabled = true; saveEditBtn.textContent = "ä¿å­˜ä¸­...";
        try { await updateDoc(doc(db, "posts", currentEditPostId), { text: newText }); closeModal(); }
        catch(e) { console.error("Error:", e); alert("ç·¨é›†ã§ãã¾ã›ã‚“ã§ã—ãŸ"); }
        finally { saveEditBtn.disabled = false; saveEditBtn.textContent = "ä¿å­˜ã™ã‚‹"; }
    });

    function escapeHtml(str) {
        if(!str) return "";
        return str.replace(/[&<>'"]/g, tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag]));
    }
</script>
</body>
</html>
